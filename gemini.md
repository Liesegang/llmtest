# AI Coding Guide & Project Documentation

This document serves as the **SINGLE SOURCE OF TRUTH** for AI agents working on this project.
**RULE: You MUST update this file whenever you add new features, change architecture, or modify project rules.**

## Project Overview

**Voice Assistant (Local LLM + TTS + STT)**
A modular voice assistant system running entirely locally.

- **LLM**: Qwen3-14B (GGUF via `llama-cpp-python`)
- **TTS**: Style-Bert-VITS2 (Local API)
- **STT**: Whisper (Local)
- **Tools**: MCP (Model Context Protocol)

## Project Structure

```
src/
├── common/         # Shared configuration and utilities (AudioIO)
├── core/           # Core application logic (VoiceAssistant, ConversationManager)
├── llm/            # LLM wrappers (LocalLLM)
├── mcp/            # Model Context Protocol client & config
├── stt/            # Speech-to-Text modules (Whisper)
├── tts/            # Text-to-Speech modules (SBV2)
└── main.py         # Entry point
```

## AI Coding Guidelines

### 1. Code Structure & Maintainability

- **SOLID Principles**: Keep classes and functions small and focused on a single responsibility.
- **Type Hinting**: **MANDATORY**. All functions and methods must have Python `typing` hints.
- **Docstrings**: Essential for public classes and functions.
- **Configuration**: NEVER hardcode values. Use `src/common/config.py`.

### 2. Testing Strategy

- **Test-Driven**: Create tests *before* or *simultaneously* with new features.
- **Framework**: Use `pytest`. Place tests in `tests/`.
- **Coverage**: **MANDATORY** for `src/core/` logic modifications.

### 3. Documentation Maintenance

- **Review this file** at the start of every session.
- **Update this file** immediately after completing a task that affects architecture or rules.

## Recent Architectural Changes

### 1. Internal Monologue Filtering

- **Logic**: Filters out `<think>...</think>` tags generated by Reasoning models.
- **Location**: `src/core/voice_assistant.py` (`_run_conversation_loop`)
- **Purpose**: Prevents internal thoughts from being spoken or displayed.

### 2. TTS Stability

- **Change**: Added guards in `src/tts/tts_sbv2.py` to reject empty/whitespace-only input.
- **Reason**: Prevents "500 Internal Server Error" from the TTS server.

### 3. Context Window Safety

- **Change**: Auto-truncation of long tool outputs (Default: 8000 chars).
- **Location**: `src/core/voice_assistant.py` (`_execute_tool_calls`), `src/common/config.py`.
- **Reason**: Prevents Context Window Overflow crashes when tools return massive data (e.g., full filesystem listings).
